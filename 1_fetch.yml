target_default: 1_fetch

include:
  - lib.yml

packages:
  - dataRetrieval
  - yaml
  - httr
  - sf
  - mapdata
  - maps
  - ncdf4
  - arrayhelpers
  - dplyr
  - xml2

file_extensions:
  - ind

sources:
  - 1_fetch/src/fetch_streamdata.R
  - 1_fetch/src/fetch_storm_track.R
  - 1_fetch/src/map_utils.R
  - 1_fetch/src/fetch_sites.R
  - 1_fetch/src/fetch_precip_spatial.R
  - 1_fetch/src/fetch_precip_values.R

targets:

  1_fetch:
    depends:
      - view_polygon
      - 1_fetch/out/storm_track.zip.ind
      - 1_fetch/out/nws_stage_sites.feather.ind
      - 1_fetch/out/streamdata.rds.ind
      - 1_fetch/out/precip_spatial.rds.ind
      - 1_fetch/out/precip_values.rds.ind

  # -- config --
  dates:
    command: viz_config[[I('dates')]]
  stream_params:
    command: yaml.load_file('1_fetch/cfg/stream_params.yml')

  # -- get spatial extent and data --

  view_config:
    command: viz_config[I(c('bbox', 'projection', 'width', 'height'))]

  1_fetch/out/view_polygon.rds.ind:
    command: post_view_polygon(target_name, view_config)
  1_fetch/out/view_polygon.rds:
    command: gd_get('1_fetch/out/view_polygon.rds.ind')
  view_polygon:
    command: get_view_polygon('1_fetch/out/view_polygon.rds.ind')

  secondary_geoms_config:
    command: viz_config[I('secondary_geoms')]
  1_fetch/out/secondary_geoms.rds.ind:
    command: fetch_geoms(target_name, secondary_geoms_config, within = view_polygon)
  1_fetch/out/secondary_geoms.rds:
    command: gd_get('1_fetch/out/secondary_geoms.rds.ind')

  focus_geoms_config:
    command: viz_config[I('focus_geoms')]
  1_fetch/out/focus_geoms.rds.ind:
    command: fetch_geoms(target_name, focus_geoms_config, within = view_polygon)
  1_fetch/out/focus_geoms.rds:
    command: gd_get('1_fetch/out/focus_geoms.rds.ind')

  # -- download stormtrack --
  storm_track_cfg:
    command: viz_config[I('storm_code')]
  1_fetch/out/storm_track.zip.ind:
    command: fetch_storm_track(ind_file=target_name, cfg=storm_track_cfg)
  1_fetch/out/storm_track.zip:
    command: gd_get('1_fetch/out/storm_track.zip.ind')

  # -- get sites and site info --
  state_cds:
    command: fetch_states_from_sf(sf_ind = '1_fetch/out/focus_geoms.rds.ind')
  1_fetch/out/all_sites.rds.ind:
    command: fetch_sites_from_states(
      ind_file = target_name,
      state_cds = state_cds,
      dates = dates,
      stream_params = stream_params)
  1_fetch/out/all_sites.rds:
    command: gd_get('1_fetch/out/all_sites.rds.ind')
  nws_nwis_crosswalk:
    command: fetch_nws_to_nwis_crosswalk(state_cds = state_cds)
  1_fetch/out/nws_stage_sites.rds.ind:
    command: fetch_nws_data(
      ind_file = target_name,
      nwis_sites_ind = '2_process/out/storm_sites_geom.rds.ind',
      nws_nwis_crosswalk = nws_nwis_crosswalk)
  1_fetch/out/nws_stage_sites.rds:
    command: gd_get('1_fetch/out/nws_stage_sites.rds.ind')

  # -- get streamdata --
  1_fetch/out/streamdata.rds.ind:
    command: fetch_streamdata(
      ind_file = target_name,
      sites_ind = '2_process/out/storm_sites.rds.ind',
      dates = dates,
      stream_params = stream_params,
      gd_config = 'lib/cfg/gd_config.yml')

  # -- get precip --
  1_fetch/out/precip_spatial.rds.ind:
    command: fetch_precip_spatial(ind_file=target_name,
                                view_polygon = view_polygon)
  1_fetch/out/precip_spatial.rds:
    command: gd_get('1_fetch/out/precip_spatial.rds.ind')

  1_fetch/out/precip_values.rds.ind:
    command: fetch_precip_values(target_name,
                                 precip_spatial_ind='1_fetch/out/precip_spatial.rds.ind',
                                 dates)

  1_fetch/out/precip_values.rds:
    command: gd_get('1_fetch/out/precip_values.rds.ind')
