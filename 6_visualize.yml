target_default: 6_visualize

include:
  - 2_process.yml

packages:
  - dplyr
  - tidyr

file_extensions:
  - feather
  - ind

sources:
  - 6_visualize/src/create_gif_tasks.R
  - 6_visualize/src/create_gif_makefile.R
  - 6_visualize/src/create_storm_frame.R
  - 6_vizprep/src/prep_plot_funs.R
  - 6_vizprep/src/prep_basemap_fun.R
  - 6_vizprep/src/prep_view_fun.R
  - 6_vizprep/src/prep_storm_point_fun.R
  - 6_vizprep/src/prep_storm_line_fun.R
  - 6_vizprep/src/prep_rivers_fun.R

targets:

  6_visualize:
    depends:
      - 6_gif_tasks.yml

  storm_frame_config:
    command: viz_config[I(c('width','height'))]

  # here we'll generate the components for basemap, focus_geoms, secondary_geoms,
  # adn storm_line. each of these components doesn't change over time. each
  # component is a closure, i.e., a function that contains all the data it needs
  # to run. the closure should accept 0 arguments. the closure should be saved
  # into an RDS file with a corresponding .rds.ind indicator file.

  # here's an example of the a single task-step for that last column=step of the task table:
  #6_visualize/out/storm_frame.png:
  #  command: create_storm_frame(
  #    png_file=target_name, config=storm_frame_config,
  #    '6_vizprep/out/view_fun.rds.ind',
  #    '6_vizprep/out/basemap_fun.rds.ind',
  #    '6_vizprep/out/storm_line_fun.rds.ind')
      #'6_vizprep/out/storm_point_[20170826-11]_fun.rds.ind',
      #'6_vizprep/out/precip_raster_[20170826-11]_fun.rds.ind',
      #'6_vizprep/out/streamdata_[20170826-11]_fun.rds.ind')

  # tmp=temporary folder for holding files to only be created on 1 computer.
  # out=folder to hold .ind and data files corresponding to shared cache or everybody's local build.
  # log=folder for the few indicator files that don't correspond to a data file.
  visualize_folders:
    command: list(
      tmp=I('6_visualize/tmp'),
      log=I('6_visualize/log'))

  view_fun:
    command: prep_view_fun(view_polygon)

  basemap_fun:
    command: prep_basemap_fun('1_fetch/out/focus_geoms.rds.ind', '1_fetch/out/secondary_geoms.rds.ind')

  storm_line_fun:
    command: prep_storm_line_fun("2_process/out/storm_line.rds.ind")

  rivers_fun:
    command: prep_rivers_fun('1_fetch/out/river_geometry.rds.ind')

  watermark_fun:
    command: prep_watermark_fun('6_visualize/in/usgs_logo_black.png')

  gif_tasks:
    command: create_gif_tasks(
      timestep_ind = '2_process/out/timesteps.rds.ind',
      folders = visualize_folders,
      storm_cfg = storm_frame_config)

  6_gif_tasks.yml:
    command: create_gif_makefile(
      makefile = target_name,
      task_plan = gif_tasks,
      remake_file = I('6_visualize.yml'))
